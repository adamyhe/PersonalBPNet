# PersonalBPNet

A small modification to bpnetlite's BPNet to accomodate large validation datasets.

Redid the validation loop to work with a PyTorch DataLoader (e.g., one generated by [GenVarLoader](https://genvarloader.readthedocs.io/en/latest/)), rather than having to load the whole validation set into memory at once. Also, the model checkpoints save the optimizer state dict, epoch number, and number of steps since last improvement in addition to the model state dict, so that training can be resumed from a checkpoint w/ the correct optimizer and early stopping/epoch states.

Additionally, we include a Pytorch implementation of CLIPNET, which is essentially BPNet with added batch norm layers, similar to what was done with the original CLIPNET implementation in tensorflow.

## Installation and programmatic usage

Clone and install github repo:

```sh
git clone git@github.com:adamyhe/PersonalBPNet.git
cd PersonalBPNet
pip install -e . # for editable mode.
```

Then the `PersonalBPNet` and `CLIPNET` classes can be directly imported:

```python
from personal_bpnet import PersonalBPNet, CLIPNET
```

The pre-trained CLIPNET models we've deposited on Zenodo (https://zenodo.org/records/14632152) are just the model weights, so to you'll need to use `load_state_dict`:

```python
from personal_bpnet import CLIPNET

os.system("wget https://zenodo.org/records/14632152/files/lcl_procap_models.tar --quiet")
os.system("tar -xvf https://zenodo.org/records/14632152/files/lcl_procap_models.tar")
model = CLIPNET(
    n_filters=512, n_outputs=2, n_control_tracks=0, n_layers=8, trimming=(2114-1000) // 2
)
model.load_state_dict(m)
model.load_state_dict(torch.load("lcl_procap_models/f1.torch")) # 9 model replicates.
```

### PauseNet

We also provide a `PauseNet` class (no published models yet because I haven't gotten this to work well). This is designed to be a wrapper around `bpnetlite.bpnet.BPNet`, `PersonalBPNet`, or `CLIPNET` models that transforms them to predict a single scalar output per input sequence. This is designed for fine-tuning the base-resolution models to predicting regulatory phenotypes that can only be represented as a single scalar value per region (e.g., pausing index, for which this class is named). The intended use for this class is as follows:

```python
from personal_bpnet import CLIPNET, PauseNet

# This is for loading from a weights dictionary.
# If you saved the full model, just directly use pretrain=torch.load("weights.torch")
pretrain = CLIPNET(**init_args)
pretrain.load_state_dict(torch.load("weights.torch"))

model = PauseNet(pretrain)
model.fit(**params)
```

This package is currently in active dev and may change drastically. Models have not been extensively benchmarked yet. May be lots of typos/copy paste errors. A personalized ChromBPNet fitting method has not been included, as I personally have not had success training such models.

## Command line interface

For convenience, prediction and attribution (DeepLIFT/SHAP) methods for CLIPNET or PauseNet models can be accessed via a CLI:

```bash
clipnet predict -h
clipnet predict_tss -h
clipnet attribute -h

pausenet predict -h
pausenet attribute -h
```
